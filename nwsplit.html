<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge'>
<meta name='viewport' content='width=device-width,initial-scale=1,user-scalable=no'>
<title>nwsplit</title>
<link rel='stylesheet' href='css/font-awesome.min.css' type='text/css'>
<style>
* {
  -webkit-app-region: no-drag;
  -webkit-user-select: none;
  -moz-user-select: none;
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}
body {
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,1);
  overflow: hidden;
  font-family: 'Input Mono', 'Segoe UI', 'Consolas', monospace;
  font-weight: bold;
  color: #FFF;
}
#container {
  display: flex;
  flex-direction: column;
}
#timer {
  order: 1;
  -webkit-app-region: drag;
  flex-shrink: 0;
  color: white;
  text-align: right;
  font-size: 60px;
  background: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#222222), to(#161616), color-stop(.9,#0C0C0C));
  border-bottom: 1px solid rgba(128,128,128,0.05);
  text-shadow: 2px 2px 5px rgba(0,0,0,1);
}
#timer.on {
  color: orange;
}
#timer.stop {
  color: orangered;
}
#timer.paused {
  color: #555;
}
#titlerow {
  flex-shrink: 0;
  order: 2;
}
#title {
  text-align: left;
  padding: 2px;
  margin-right: 30px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: skyblue;
}
#attempts {
  float: right;
  padding: 2px;
  color: #808080;
}
#splits {
  order: 3;
  flex-grow: 1;
  height: 100%;
  width: 100%;
  overflow: hidden;
}
.split {
  text-align: right;
  padding: 2px;
}
.split:nth-child(odd) {
  background: rgba(128,128,128,0.1);
}
.split.current {
  background: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#372D1C), to(#26221C), color-stop(.9,#1C1C1C));
}
.time {
  min-width: 85px;
  display: inline-block;
}
.diff {
  color: white;
}
.diff.worse {
  color: firebrick;
}
.diff.better {
  color: limegreen;
}
.diff.gold {
  color: gold!important;
}
.worse::before {
  content: '+';
}
.better::before {
  content: '-';
}
.name {
  float: left;
  display: inline-block;
  text-align: left;
  min-width: 85px;
}
#bar {
  flex-shrink: 0;
  order: 5;
  cursor: pointer;
  white-space: nowrap;
  height: 50px;
  border-top: 1px solid rgba(128,128,128,0.1);
  background: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#222222), to(#161616), color-stop(.9,#0C0C0C));
}
#bar i {
  height: 50px;
  width: 14.28571428571429%;
  text-align: center;
  line-height: 50px;
  display: inline-block;
}
@media (max-height: 120px) {
  #bar {
    display: none!important;
  }
}
</style>
<style id='custom'></style>
</head>
<body>
<div id='container'>
  <div id='titlerow'>
    <div id='attempts'></div>
    <div id='title' contenteditable='true'>Title</div>
  </div>
  <div id='splits'></div>
  <div id='timer'></div>
  <div id='bar'>
    <i class='fa fa-save fa-2x' onclick='exportWsplit()'></i><i class='fa fa-folder-open fa-2x' onclick='importWsplit()'></i><i class='fa fa-trash fa-2x' onclick='trash()'></i><i class='fa fa-power-off fa-2x' onclick='reset()'></i><i class='fa fa-pause fa-2x' onclick='pause()'></i><i class='fa fa-stop fa-2x' onclick='stop()'></i><i class='fa fa-play fa-2x' onclick='split()'></i>
  </div>
</div>
<script src='jquery-2.1.3.min.js'></script>
<script src='node_modules/moment/min/moment.min.js'></script>
<script src='node_modules/moment-duration-format/lib/moment-duration-format.js'></script>
<script>
var title = (localStorage.title?localStorage.title:'Game title')
var splits = (localStorage.splits?JSON.parse(localStorage.splits):[])
var defaults = {precision: 2, format: 'd[d] hh:mm:ss', global_split: 'Ctrl+F12', global_stop: 'Ctrl+F11', global_reset: 'Ctrl+F9', global_pause: 'Ctrl+F10', local_split: 123, local_stop: 122, local_reset: 120, local_pause: 121, offset: 0, interval: 10, autoadd: false, ontop: true, trim: 'left', zoom: 0, css: '', attempts: 0}
var options = (localStorage.options&&JSON.parse(localStorage.options)?JSON.parse(localStorage.options):defaults)
if(typeof process !== 'undefined') {
  var gui = require('nw.gui')
  var win = gui.Window.get()
  win.setAlwaysOnTop(options.ontop)
  win.zoomLevel = options.zoom
  var moment = require('moment')
  require('moment-duration-format')
  var fs = require('fs')
  gui.App.registerGlobalHotKey(new gui.Shortcut({key: options.global_split,active: function(){split()},failed: function(msg){console.log(msg)}}))
  gui.App.registerGlobalHotKey(new gui.Shortcut({key: options.global_stop,active: function(){stop()},failed: function(msg){console.log(msg)}}))
  gui.App.registerGlobalHotKey(new gui.Shortcut({key: options.global_reset,active: function(){reset()},failed: function(msg){console.log(msg)}}))
  gui.App.registerGlobalHotKey(new gui.Shortcut({key: options.global_pause,active: function(){pause()},failed: function(msg){console.log(msg)}}))
  if(localStorage.x) {
    win.x = localStorage.x
  }
  if(localStorage.y) {
    win.y = localStorage.y
  }
  if(localStorage.width) {
    win.width = localStorage.width
  }
  if(localStorage.height) {
    win.height = localStorage.height
  }
  var menu = new gui.Menu()
  menu.append(new gui.MenuItem({ label: 'Import splits' }))
  menu.append(new gui.MenuItem({ label: 'Export splits' }))
  menu.append(new gui.MenuItem({ type: 'separator' }))
  menu.append(new gui.MenuItem({ label: 'Start / Split' }))
  menu.append(new gui.MenuItem({ label: 'Stop / PBs to splits' }))
  menu.append(new gui.MenuItem({ label: 'Pause / Unpause' }))
  menu.append(new gui.MenuItem({ label: 'Reset' }))
  menu.append(new gui.MenuItem({ label: 'Clear all' }))
  menu.append(new gui.MenuItem({ label: 'Undo split' }))
  menu.append(new gui.MenuItem({ type: 'separator' }))
  menu.append(new gui.MenuItem({ label: 'Change options' }))
  menu.append(new gui.MenuItem({ label: 'Add custom theme' }))
  menu.append(new gui.MenuItem({ label: 'Clear custom theme' }))
  menu.append(new gui.MenuItem({ label: 'Load defaults' }))
  menu.append(new gui.MenuItem({ label: 'Show toolbar' }))
  menu.append(new gui.MenuItem({ label: 'Open devtools' }))
  menu.append(new gui.MenuItem({ type: 'separator' }))
  menu.append(new gui.MenuItem({ label: 'Exit' }))
  menu.items[0].click = function() { importWsplit() }
  menu.items[1].click = function() { exportWsplit() }
  menu.items[3].click = function() { split() }
  menu.items[4].click = function() { stop() }
  menu.items[5].click = function() { pause() }
  menu.items[6].click = function() { reset() }
  menu.items[7].click = function() { trash() }
  menu.items[8].click = function() { undo() }
  menu.items[10].click = function() { loopOptions() }
  menu.items[11].click = function() { getCss() }
  menu.items[12].click = function() { $('#custom').html(''); save() }
  menu.items[13].click = function() { localStorage.clear(); alert('Restart to see changes.') }
  menu.items[14].click = function() { $('#bar').slideToggle() }
  menu.items[15].click = function() { win.showDevTools() }
  menu.items[17].click = function() { win.close() }
  window.oncontextmenu = function(e) {
    if(e.button == 2) {
      menu.popup(e.clientX, e.clientY)
    }
  }
  if(process.platform.match(/linux|darwin/ig)) {
    if(fs.existsSync('/tmp/nwsplit.sock')) {
      fs.unlinkSync('/tmp/nwsplit.sock')
    }
    var net = require('net')
    var server = net.createServer(function(stream) {
      stream.on('data', function(c) {
        eval(c.toString())
      })
    })
    server.listen('/tmp/nwsplit.sock')
  }
  win.on('close', function() {
    this.hide()
    if(server) {
      server.close()
    }
    save()
    this.close(true)
  })
}
var inter = 0
var n = 0
var time = 0
var pausetime = 0
var paused = false
var pausestart = 0
var start = 0
var file = 0
var resets = 0
var stops = 0
var getCss = function() {
  var file = document.createElement('input')
  file.setAttribute('type', 'file')
  file.setAttribute('accept', '.css')
  file.onchange = function() {
    var reader = new FileReader()
    reader.onloadend = function() {
      data = reader.result
      $('#custom').html(data)
      save()
    }
    reader.readAsText(this.files[0])
  }
  file.click()
}
var loopOptions = function() {
  var help = {
    ontop: '[ontop] Always on top, true/false (default true)',
    zoom: '[zoom] Zoom level, -n..n (default 0)',
    precision: '[precision] Number of decimals in last token, 0..3 (default 2)',
    format: '[format] Time format, moment-duration-format (default d[d] hh:mm:ss)',
    trim: '[trim] Trim leading zeroes, left/right/false (default left)',
    interval: '[interval] Timer update interval, ms (default 10)',
    autoadd: '[autoadd] Autoadd new splits or stop on last split, true/false (default false)',
    offset: '[offset] Timer start offset, ms (default 0)',
    attempts: '[attempts] Number of attempts (default 0)',
    global_split: '[global_split] Global hotkey: Start/Split (default Ctrl+F12)',
    global_stop: '[global_stop] Global hotkey: Stop/PB->Splits (default Ctrl+F11)',
    global_pause: '[global_pause] Global hotkey: Pause/Unpause (default Ctrl+F10)',
    global_reset: '[global_reset] Global hotkey: Reset/Clear (default Ctrl+F9)',
    local_split: '[local_split] Local hotkey: Start/Split, keycode (default 123)',
    local_stop: '[local_stop] Local hotkey: Stop/PB->Splits, keycode (default 122)',
    local_pause: '[local_pause] Local hotkey: Pause/Unpause, keycode (default 121)',
    local_reset: '[local_reset] Local hotkey: Reset/Clear, keycode (default 120)'
  }
  var changes = false
  for(var i in help) {
    var ans = prompt(help[i], options[i])
    if(ans == null) {
      return
    }
    if(!isNaN(parseFloat(ans))) {
      ans = parseFloat(ans)
    }
    if(ans === 'true') {
      ans = true
    }
    if(ans === 'false') {
      ans = false
    }
    if(ans !== options[i]) {
      options[i] = ans
      changes = true
    }
  }
  if(changes) {
    if(confirm('You need to restart to see changes. Quit now?')) {
      save()
      win.close()
    }
  }
}
var save = function() {
  localStorage.title = title
  localStorage.splits = JSON.stringify(splits)
  options.css = $('#custom').html()
  localStorage.options = JSON.stringify(options)
  if(typeof win !== 'undefined') {
    localStorage.width = win.width
    localStorage.height = win.height
    localStorage.x = win.x
    localStorage.y = win.y
  }
}
var undo = function() {
  if(!inter) {
    split()
  } else if(n>0) {
    $('.split:nth('+n+') .diff').html('').removeClass('better worse')
    n--
  }
}
var split = function() {
  if(paused) {
    pause()
    return
  }
  if(!inter) {
    if(!time) {
      start = new Date().getTime()-options.offset
      n=0
      options.attempts++
      $('#attempts').html(options.attempts)
    }
    inter = setInterval(updateTime, options.interval)
    $('#timer').removeClass('stop').addClass('on')
  } else {
    if(!options.autoadd && n >= splits.length-1) {
      stop()
      return
    }
    addSplit()
    n++
  }
  centerSplit()
}
var addSplit = function() {
  var split = (new Date().getTime()-start)
  if(start == 0) {
    split = 0
  }
  var seg = split
  if(splits[n-1]) {
    seg = split - splits[n-1].current
  }
  var name = 'Split '+(1+n)
  if(splits.length <= n) {
    splits[n] = { name: name, current: split, best: split, seg: seg, bestseg: seg }
    appendSplit(name, time)
  }
  splits[n].current = split
  splits[n].seg = seg
  splits[n].bestseg = splits[n].bestseg || seg
}
var stop = function() {
  if(inter == 0) {
    for(var i in splits) {
      if(splits[i].current < splits[i].best || stops > 5) {
        splits[i].best = splits[i].current
        $('.time:nth('+i+')').html(moment.duration(splits[i].current).format(options.format, options.precision, {trim: options.trim}))
      }
      if(splits[i].seg < splits[i].bestseg || stops > 5) {
        splits[i].bestseg = splits[i].seg
      }
    }
    if(splits.length == 0 || splits[0].best == 0) {
      if(n==0) {
        n=splits.length
      }
      addSplit()
      if(time == options.offset) {
        n++
      }
    }
  } else {
    if(splits[n]) {
      var split = (new Date().getTime()-start)
      var seg = split
      if(splits[n-1]) {
        seg = split - splits[n-1].current
      }
      splits[n].current = split
      splits[n].seg = seg
      splits[n].bestseg = splits[n].bestseg || seg
    } else {
      addSplit()
    }
    clearInterval(inter)
    inter = 0
    paused = false
    pausetime = 0
    $('#timer').removeClass('on paused').addClass('stop')
  }
  if(stops == 0) {
    setTimeout(function(){stops = 0},700)
  }
  stops++
  save()
}
var trash = function() {
  reset()
  resets = 10
  reset()
}
var reset = function() {
  if(time==0 && !paused && !$('#timer').hasClass('stop') && resets > 5) {
    splits = []
    $('#splits').html('')
    title = 'Game title'
    $('#title').html(title)
    options.attempts = 0
    $('#attempts').html(options.attempts)
    save()
  }
  if(resets == 0) {
    setTimeout(function(){resets = 0},700)
  }
  resets++
  $('#timer').removeClass('on stop paused')
  clearInterval(inter)
  start = 0
  inter = 0
  n = 0
  time = 0
  pausetime = 0
  paused = false
  $('#timer').html((options.offset<0?'-':'')+moment.duration(options.offset).format(options.format, options.precision, {trim: options.trim}))
  $('.diff').removeClass('better worse gold')
  $('.diff').html('')
  $('.split').removeClass('current')
  centerSplit()
  save()
}
var pause = function() {
  if(paused) {
    pausetime = new Date().getTime()-pausestart
    start += pausetime
    paused = false
  } else if(inter) {
    pausestart = new Date().getTime()
    paused = true
  }
}
var centerSplit = function() {
  resizeSplits()
  var el = $('.split[data-id='+n+']')
  if(el.length == 0) {
    return
  }
  var from = { top: $('#splits').scrollTop(), left: $('#splits').scrollLeft() }
  $('#splits').scrollTop(0)
  $('#splits').scrollLeft(0)
  var to = { top: el.position().top-$('#splits').position().top-$('#splits').height()/2+el.height()/2, left: el.position().left-$('#splits').position().left-$('#splits').width()/2+el.width()/2 }
  $('#splits').scrollTop(from.top)
  $('#splits').scrollLeft(from.left)
  $('#splits').stop(true,true).animate({scrollTop: to.top, scrollLeft: to.left}, {duration: 200, queue: false})
  //$('#splits').scrollTop(to.top)
  //$('#splits').scrollLeft(to.left)
}
var resizeSplits = function() {
  $('#container').height($(window).height())
  $('#container').width($(window).width())
}
var updateTime = function() {
  $('#timer').removeClass('paused')
  if(paused) {
    $('#timer').addClass('paused')
  } else if(inter) {
    time = new Date().getTime()-start
  } else {
    time = options.offset
  }
  $('#timer').html((time<0?'-':'')+moment.duration(time).format(options.format, options.precision, {trim: options.trim}))
  if(time > 0 && splits[n]){
    $('.diff:nth('+n+')').html(moment.duration(time-splits[n].best).format(options.format, options.precision, {trim: options.trim}))
    if(time > splits[n].best) {
      $('.diff:nth('+n+')').removeClass('better').addClass('worse')
    } else {
      $('.diff:nth('+n+')').removeClass('worse').addClass('better')
    }
    var seg = time
    if(n > 0) {
      seg = time - splits[n-1].current
    }
    if(seg < splits[n].bestseg) {
      $('.diff:nth('+n+')').addClass('gold')
    } else {
      $('.diff:nth('+n+')').removeClass('gold')
    }
  }
  $('.split').removeClass('current')
  $('.split:nth('+n+')').addClass('current')
}
var appendSplit = function(myname, mytime) {
  var id = $('.split').length
  $('#splits').append('<div class="split" data-id="'+id+'"><span class="name" contenteditable="true">'+myname+'</span><span class="diff"></span><span class="time" contenteditable="true">'+moment.duration(mytime).format(options.format, options.precision, {trim: options.trim})+'</span></div>')
}
var die = function() {
  localStorage.clear()
  gui.App.quit()
}
var exportWsplit = function() {
  var data = 'Title='+title+'\nAttempts='+options.attempts+'\nOffset=0\nSize=200,25\n'
  for(var i in splits) {
    data += splits[i].name+',0,'+(splits[i].best/1000)+','+(splits[i].bestseg/1000)+'\n'
  }
  data += 'Icons='+Array(splits.length).join('"",')+'""'
  if(typeof fs !== 'undefined') {
    var file = document.createElement('input')
    file.setAttribute('type', 'file')
    file.setAttribute('nwsaveas', title+'.wsplit')
    file.onchange = function() {
      var path = this.files[0].path
      fs.writeFile(path, data)
    }
    file.click()
  } else {
    var ex = document.createElement('a')
    ex.setAttribute('href', 'data:text/plain;charset=utf-8,'+encodeURIComponent(data))
    ex.setAttribute('download',title+'.wsplit')
    ex.click()
  }
}
var importWsplit = function() {
  var file = document.createElement('input')
  file.setAttribute('type', 'file')
  file.setAttribute('accept', '.wsplit')
  file.onchange = function() {
    var reader = new FileReader()
    reader.onloadend = function() {
      var metareg = false
      var reg = false
      if(file.files[0].name.match(/\.wsplit$/)) {
        metareg = /Title=(.*)$[^]*?(Attempts=(.*?)$)/gm
        reg = /^(.*),[\d\.]*,([\d\.]*),([\d\.]*)$/gm
      } else {
        return
      }
      var meta = metareg.exec(reader.result)
      title = meta[1]
      $('#title').html(title)
      attempts = meta[3] || 0
      $('#attempts').html(attempts)
      splits = []
      $('#splits').html('')
      while(found = reg.exec(reader.result)) {
        var newtime = moment.duration(1000*found[2])
        var newseg = moment.duration(1000*found[3])
        var newname = String(found[1])
        splits.push({name: newname, current: 1*newtime, best: 1*newtime, seg: 1*newseg, bestseg: 1*newseg})
        appendSplit(newname, newtime)
      }
      save()
    }
    reader.readAsText(this.files[0])
  }
  file.click()
}
$(function() {
  resizeSplits()
  $('#title').html(title)
  $('#attempts').html(options.attempts)
  $('#custom').html(options.css)
  $(window).resize(function(e) {
    centerSplit()
  })
  $(window).keydown(function(e) {
    if(e.which == options.local_split) {
      e.preventDefault()
      split()
    } else if(e.which == options.local_stop) {
      e.preventDefault()
      stop()
    } else if(e.which == options.local_reset) {
      e.preventDefault()
      reset()
    } else if(e.which == options.local_pause) {
      e.preventDefault()
      pause()
    }
  })
  $('#timer').html((options.offset<0?'-':'')+moment.duration(options.offset).format(options.format, options.precision, {trim: options.trim}))
  for(var i in splits) {
    appendSplit(splits[i].name, splits[i].best)
  }
  $('#container').on('click', '[contenteditable="true"]', function(e){
    e.preventDefault()
    e.stopPropagation()
    document.execCommand('selectAll', false, null)
  })
  $('#splits').on('click', function(e){
    if($(e.target).is('.split, #splits')) {
      $('[contenteditable="true"]').blur()
    }
  })
  $('#container').on('focus', '.time', function(e) {
    var id = $(this).parents('.split').attr('data-id')
    var val = splits[id].best/1000
    $(this).html(val)
  })
  $('#container').on('blur', '.time', function(e) {
    if(!e.isSimulated) {
      return false
    }
    var id = $(this).parents('.split').attr('data-id')
    if(!splits[id]) {
      return
    }
    var val = 1000*$(this).html()
    splits[id].best = val
    $(this).html(moment.duration(val).format(options.format, options.precision, {trim: options.trim}))
    save()
  })
  $('#container').on('blur', '.name', function(e) {
    var id = $(this).parents('.split').attr('data-id')
    if(!splits[id]) {
      return
    }
    var val = $(this).html()
    if(val == '') {
      splits.splice(id, 1)
      $(this).parents('.split').remove()
      var m = 0
      $('.split').each(function() {
        $(this).attr('data-id', m)
        m++
      })
      if(n>id) {
        n--
      }
    } else {
      splits[id].name = val
    }
    save()
  })
  $(window).bind('mousewheel', function(e){
      if(e.originalEvent.wheelDelta /120 > 0) {
          win.zoomLevel += 0.1
      } else {
          win.zoomLevel -= 0.1
      }
      options.zoom = win.zoomLevel
      save()
  });
  $(window).scroll(function() {
    $(window).scrollTop(0)
    $(window).scrollLeft(0)
  })
  if(!('ontouchstart' in document.documentElement)) {
    $('#bar').hide()
  }
  $('#title').blur(function() {
    title = $('#title').html()
    save()
  })
  $('#splits').dblclick(function(e) {
    e.preventDefault()
    if(splits.length == 0) {
      importWsplit()
    } else {
      exportWsplit()
    }
  })
  /*$('#file')[0].onclick = function(e){ if(e.which){ e.preventDefault() }}
  $('#file').dblclick(function(){ $('#file').click() })*/
  window.ondragover = function(e) { e.preventDefault(); return false }
  window.ondrop = function(e){ if(e.target.id != 'file') { e.preventDefault(); return false }}
})
</script>
</body>
</html>
