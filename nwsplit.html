<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge'>
<meta name='viewport' content='width=device-width,initial-scale=1,user-scalable=no'>
<title>nwsplit</title>
<link rel='stylesheet' href='css/font-awesome.min.css' type='text/css'>
<style>
* {
  -webkit-app-region: no-drag;
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}
body {
  width: 100%;
  height: 100%;
  min-height: 300px;
  background: rgba(0,0,0,1);
  overflow: hidden;
  font-family: 'Input Mono', 'Consolas', monospace;
  color: #FFF;
}
#container {
  position: relative;
}
#title {
  text-align: center;
  padding: 2px;
}
.timer {
  -webkit-app-region: drag;
  color: white;
  text-align: right;
  font-size: 60px;
  font-weight: bold;
  background: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#222222), to(#161616), color-stop(.9,#0C0C0C));
  border-bottom: 1px solid rgba(128,128,128,0.05);
  text-shadow: 2px 2px 5px rgba(0,0,0,1);
}
.timer.on {
  color: orange;
}
.timer.stop {
  color: orangered;
}
.timer.paused {
  color: #555;
}
.split {
  text-align: right;
  padding: 2px;
}
.split:nth-child(odd) {
  background: rgba(128,128,128,0.1);
}
.split.current {
  background: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#372D1C), to(#26221C), color-stop(.9,#1C1C1C));
}
.time {
  min-width: 85px;
  display: inline-block;
}
.diff {
  color: white;
}
.diff.worse {
  color: firebrick;
}
.diff.better {
  color: limegreen;
}
.worse::before {
  content: '+';
}
.better::before {
  content: '-';
}
.name {
  float: left;
}
#import {
  opacity: 0;
}
#file {
  display: block;
  height: 1000px;
  width: 100%;
}
#bar {
  cursor: pointer;
  display: none;
  white-space: nowrap;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  width: 100%;
  height: 50px;
  border-top: 1px solid rgba(128,128,128,0.1);
  background: -webkit-gradient(linear, 0% 0%, 0% 100%, from(#222222), to(#161616), color-stop(.9,#0C0C0C));
}
#bar i {
  height: 50px;
  width: 25%;
  text-align: center;
  line-height: 50px;
  display: inline-block;
}
</style>
</head>
<body>
<div id='container'>
<div id='timer' class='timer'></div>
<div id='title' contenteditable='true'>Title</div>
<div id='splits' class='splits'></div>
<div id='import'><input type='file' id='file' accept='.lss,.wsplit' tabindex='-1'></div>
<div id='bar'>
<i class='fa fa-power-off fa-2x' onclick='reset()'></i><i class='fa fa-pause fa-2x' onclick='pause()'></i><i class='fa fa-stop fa-2x' onclick='stop()'></i><i class='fa fa-play fa-2x' onclick='split()'></i>
</div>
</div>
<script src='jquery-2.1.3.min.js'></script>
<script src='node_modules/moment/min/moment.min.js'></script>
<script src='node_modules/moment-duration-format/lib/moment-duration-format.js'></script>
<script>
var title = (localStorage.title?localStorage.title:'Game title')
$('#title').html(title)
var splits = (localStorage.splits?JSON.parse(localStorage.splits):[])
var options = (localStorage.options&&JSON.parse(localStorage.options)?JSON.parse(localStorage.options):{precision: 2, format: 'd[d] h:mm:ss', global_split: 'Ctrl+F12', global_stop: 'Ctrl+F11', global_reset: 'Ctrl+F9', global_pause: 'Ctrl+F10', local_split: 123, local_stop: 122, local_reset: 120, local_pause: 121, offset: 0, interval: 10, autoadd: true, bar: true})
if(localStorage.style) {
  $('style').html(localStorage.style)
}
if(typeof require !== 'undefined') {
  var gui = require('nw.gui')
  var win = gui.Window.get()
  win.showDevTools()
  gui.App.registerGlobalHotKey(new gui.Shortcut({key: options.global_split,active: function(){split()},failed: function(msg){console.log(msg)}}))
  gui.App.registerGlobalHotKey(new gui.Shortcut({key: options.global_stop,active: function(){stop()},failed: function(msg){console.log(msg)}}))
  gui.App.registerGlobalHotKey(new gui.Shortcut({key: options.global_reset,active: function(){reset()},failed: function(msg){console.log(msg)}}))
  gui.App.registerGlobalHotKey(new gui.Shortcut({key: options.global_pause,active: function(){pause()},failed: function(msg){console.log(msg)}}))
  win.on('close', function() {
    save()
    win.close(true)
  })
  if(localStorage.x) {
    win.x = localStorage.x
  }
  if(localStorage.y) {
    win.y = localStorage.y
  }
  if(localStorage.width) {
    win.width = localStorage.width
  }
  if(localStorage.height) {
    win.height = localStorage.height
  }
  var moment = require('moment')
  require('moment-duration-format')
  var fs = require('fs')
}
var inter = 0
var n = 0
var time = 0
var pausetime = 0
var paused = false
var pausestart = 0
var start = 0
var file = 0
console.info('This program was done in a few hours for fun. Don\'t expect it to work. It does however have some cool features other splitters dont. You can for example make it completely transparent (see css) or edit splits while the timer is running.')
console.info('You can close the devtools or use it to edit the options in console or the CSS in elements. Simple zooming works with mousewheel. If you break something you might need to remove %localappdata%/nwsplit or equivalent. Here are your "var options":')
console.info(options)
console.info('Options, CSS and splits are saved to localStorage automatically. The split key adds new splits automatically if options.autoadd is true, or you can add empty splits by mashing stop. Double pressing stop updates splits with new records, double pressing reset clears everything. You can drop .lss/.wsplit files to the empty space under the timer (or click.) You can also edit split names and times (in seconds) by clicking.')
var save = function() {
  localStorage.title = title
  localStorage.splits = JSON.stringify(splits)
  localStorage.options = JSON.stringify(options)
  localStorage.style = $('style').html()
  if(typeof win !== 'undefined') {
    localStorage.width = win.width
    localStorage.height = win.height
    localStorage.x = win.x
    localStorage.y = win.y
  }
}
var split = function() {
  if(!inter) {
    if(!time) {
      start = new Date().getTime()-options.offset
    }
    inter = setInterval(updateTime, options.interval)
    $('.timer').removeClass('stop').addClass('on')
  } else {
    if(!options.autoadd && n >= splits.length-1) {
      stop()
      return
    }
    addSplit()
    n++
  }
}
var addSplit = function() {
  var split = (new Date().getTime()-start)
  if(start == 0) {
    split = 0
  }
  var name = 'Split '+(1+n)
  if(splits.length <= n) {
    splits[n] = { name: name, current: split, best: split }
    appendSplit(name, time)
  }
  splits[n].current = split
}
var stop = function() {
  if(inter == 0) {
    for(var i in splits) {
      if(splits[i].current < splits[i].best) {
        splits[i].best = splits[i].current
        $('.time:nth('+i+')').html(moment.duration(splits[i].current).format(options.format, options.precision))
      }
    }
  }
  if(splits.length == 0 || $('.split:nth('+n+')').length == 0 || (!options.autoadd && time == options.offset)) {
    addSplit()
    if(time == options.offset) {
      n++
    }
  }
  if(splits[n]) {
    var split = (new Date().getTime()-start)
    splits[n].current = split
  }
  clearInterval(inter)
  $('.timer').removeClass('on paused').addClass('stop')
  inter = 0
  paused = false
  pausetime = 0
  save()
}
var reset = function() {
  $('.timer').removeClass('on stop paused')
  if(time==0) {
    splits = []
    $('.splits').html('')
  }
  clearInterval(inter)
  start = 0
  inter = 0
  n = 0
  time = 0
  pausetime = 0
  paused = false
  $('.timer').html((options.offset<0?'-':'')+moment.duration(options.offset).format(options.format, options.precision))
  $('.diff').removeClass('better worse')
  $('.diff').html('')
  $('.split').removeClass('current')
  save()
}
var pause = function() {
  if(paused) {
    pausetime = new Date().getTime()-pausestart
    start += pausetime
    paused = false
  } else {
    pausestart = new Date().getTime()
    paused = true
  }
}
var updateTime = function() {
  $('.timer').removeClass('paused')
  if(paused) {
    $('.timer').addClass('paused')
  } else if(inter) {
    time = new Date().getTime()-start
  } else {
    time = options.offset
  }
  $('.timer').html((time<0?'-':'')+moment.duration(time).format(options.format, options.precision))
  if(time > 0 && splits[n]){
    //$('.time:nth('+n+')').html(moment.duration(time).format(format, 2))
    $('.diff:nth('+n+')').html(moment.duration(time-splits[n].best).format(options.format, options.precision))
    if(time > splits[n].best) {
      $('.diff:nth('+n+')').removeClass('better').addClass('worse')
    } else {
      $('.diff:nth('+n+')').removeClass('worse').addClass('better')
    }
  }
  $('.split').removeClass('current')
  $('.split:nth('+n+')').addClass('current')
}
var appendSplit = function(myname, mytime) {
  var id = $('.split').length
  $('.splits').append('<div class="split" data-id="'+id+'"><span class="name" contenteditable="true">'+myname+'</span><span class="diff"></span><span class="time" contenteditable="true">'+moment.duration(mytime).format(options.format, options.precision)+'</span></div>')
}
var die = function() {
  localStorage.clear()
  win.close(true)
}
var generateWsplit = function() {
  var data = 'Title='+title+'\nAttempts=0\nOffset=0\nSize=200,25\n'
  for(var i in splits) {
    data += splits[i].name+',0,'+(splits[i].current/1000)+','+(splits[i].best/1000)+'\n'
  }
  data += 'Icons='+Array(splits.length).join('"",')+'""'
  if(typeof fs !== 'undefined') {
    fs.writeFile(title+'.wsplit', data)
  } else {
    var ex = document.createElement('a')
    ex.setAttribute('href', 'data:text/plain;charset=utf-8,'+encodeURIComponent(data))
    ex.setAttribute('download',title+'.wsplit')
    ex.click()
  }
}
$(function() {
  $(window).keydown(function(e) {
    if(e.which == options.local_split) {
      e.preventDefault()
      split()
    } else if(e.which == options.local_stop) {
      e.preventDefault()
      stop()
    } else if(e.which == options.local_reset) {
      e.preventDefault()
      reset()
    } else if(e.which == options.local_pause) {
      e.preventDefault()
      pause()
    }
  })
  $('.timer').html((options.offset<0?'-':'')+moment.duration(options.offset).format(options.format, options.precision))
  for(var i in splits) {
    appendSplit(splits[i].name, splits[i].best)
  }
  $('#container').on('click', '.split', function(e) {
    e.stopPropagation()
    $(this).find('.name').focus()
  })
  $('#container').on('click', '.time', function(e) {
    e.stopPropagation()
    $(this).find('.time').focus()
  })
  $('#file').on('change', function() {
    var reader = new FileReader()
    reader.onloadend = function() {
      var reg = false
      var titlereg = false
      var multi = false
      var data = ''
      if($('#file')[0].files[0].name.match(/\.lss$/)) {
        reg = /<Name>([^<]*).*?<RealTime>([^<]*)</g
        data = reader.result.replace(/(\r\n|\n|\r)/gm,'')
        titlereg = /<GameName>([^<]*)</gm
      } else if($('#file')[0].files[0].name.match(/\.wsplit$/)) {
        reg = /^([^,]*),0,([^,]*),.*?$/gm
        multi = 1000
        data = reader.result
        titlereg = /Title=(.*)/gm
      }
      if(!reg) {
        $('#file')[0].files.clear()
        return
      }
      title = titlereg.exec(data)[1]
      $('#title').html(title)
      splits = []
      $('.splits').html('')
      while(found = reg.exec(data)) {
        if(multi) {
          found[2] = multi*found[2]
        }
        var newtime = moment.duration(found[2])
        var newname = String(found[1])
        splits.push({name: newname, current: 1*newtime, best: 1*newtime})
        appendSplit(newname, newtime)
      }
      save()
      $('#file')[0].files.clear()
    }
    reader.readAsText(this.files[0])
  })
  $('#container').on('focus', '.time', function(e) {
    var id = $(this).parents('.split').data('id')
    var val = splits[id].best/1000
    $(this).html(val)
  })
  $('#container').on('blur', '.time', function(e) {
    var id = $(this).parents('.split').data('id')
    if(!splits[id]) {
      return
    }
    var val = 1000*$(this).html()
    splits[id].best = val
    $(this).html(moment.duration(val).format(options.format, options.precision))
  })
  $(window).bind('mousewheel', function(e){
      if(e.originalEvent.wheelDelta /120 > 0) {
          win.zoomLevel += 0.1
      }
      else{
          win.zoomLevel -= 0.1
      }
  });
  $(window).scroll(function() {
    $(window).scrollTop(0)
  })
  if(options.bar) {
    $('#bar').show()
    $('#bar').mousemove(function() {
      if(!options.bar) {
        return
      }
      if(!('ontouchstart' in document.documentElement) && $(window).height() > 120) {
        $('#bar').stop().css({opacity: 1}).animate({opacity: 0}, 2000);
      }
    })
  }
  $('#title').blur(function() {
    title = $('#title').html()
    save()
  })
  $('.splits').dblclick(function(e) {
    e.preventDefault()
    generateWsplit()
  })
  $('#bar').mousedown(function() {
    return false
  })
  window.ondragover = function(e) { e.preventDefault(); return false };
  /*window.ondrop = function(e) { e.preventDefault(); return false };*/
})
</script>
</body>
</html>
